<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head th:replace="partials/partials.html :: head ('Create A Topster')">
</head>
<body onload="onPageLoad()">
    <nav th:replace="partials/partials.html :: navbar"></nav>
    <main>
        <h1>Create a topster!</h1>

    <!--    <div id="album-art"></div><br>-->
        <input id="search-bar" type="text">
        <button id="search-button">Search</button>
        <label for="topster-type">Select a topster style</label>
        <select name="topster-type" id="topster-type" onchange="changeSelection()">
            <option value="5x5">5x5</option>
            <option value="4x4" selected>4x4</option>
            <option value="3x3">3x3</option>
        </select>
        <div class="container row">
            <div class="col-6">
                <div id="results" class="row"></div>
            </div>

                <div id="3x3" th:replace="partials/3x3-topster.html :: 3x3-topster" style="display: none"></div>
                <div id="4x4" th:replace="partials/4x4-topster.html :: 4x4-topster"></div>
                <div id="5x5" th:replace="partials/5x5-topster.html :: 5x5-topster"></div>

        </div>

    </main>
    <script th:replace="partials/partials.html :: md-js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="/keys.js"></script>
    <script>
        'use strict';

        (function (){
            var _numOfImageSlots = 16;
            var _numOfImagesPerRow = 4;
            var _imageMarginBottom = 30;
            var imageSlots = [];
            var _selectedImageElement = null,
                    _originalImageSlot = null,
                    _originalClickCoords = null;
            function init(){
                addImageSlots();

                document.getElementById('dragDrop').addEventListener('mousemove', imageMousemove)
            }

            var wrap = document.getElementById('dragDrop');

            function addImageSlots(){
                var len = _numOfImageSlots;
                var item;
                for(let i =0; i<len; i++){
                    item = window.document.createElement('div');
                    item.setAttribute('class', 'dd-slot');
                    item.setAttribute('style', 'width:' + (100/_numOfImagesPerRow)+"%;paddint-bottom:" + (100/_numOfImagesPerRow)+";margin-bottom:" + _imageMarginBottom + "px;");

                    item.innerHTML = '<p class="dd-slot-num dd-vc">' + (i+1) +  '</p>';
                }
            }
            function imageMousedown ( event ) {
                if ( !_selectedImageElement ) {
                    _selectedImageElement = event.currentTarget;
                    _originalClickCoords = { x: event.pageX, y: event.pageY };
                    _originalImageSlot = getIndexOfImageId( _selectedImageElement.getAttribute('data-image-id') );
                    _selectedImageElement.classList.add('dd-selected');
                    _selectedImageElement.classList.remove('dd-transition');
                }
            }

            function getSlotIdByCoords ( coords ) {
                // Get the current slot being hovered over
                for ( var id in _imageSlots ) {
                    var slot = _imageSlots[id];
                    if ( slot.x <= coords.x && coords.x <= slot.x + slot.width && slot.y <= coords.y && coords.y <= slot.y + slot.height )
                        return id;
                }
            }

            function imageMousemove ( event ) {

                if ( _selectedImageElement ) {

                    var wrap = _doc.getElementById('dragDrop'),
                            bounds = wrap.getBoundingClientRect(),
                            left = bounds.left,
                            top = bounds.top;

                    var pageX = event.pageX,
                            pageY = event.pageY;

                    var clickX = pageX - left,
                            clickY = pageY - top,
                            hoverSlotId = getSlotIdByCoords( { x: clickX, y: clickY } );

                    var ele = _selectedImageElement,
                            imageId = ele.getAttribute('data-image-id'),
                            index = _originalImageSlot,
                            newIndex = getIndexOfImageId( imageId ),
                            x = _imageSlots[index].x,
                            y = _imageSlots[index].y;

                    var resultX = x + ( pageX - _originalClickCoords.x ),
                            resultY = y + ( pageY - _originalClickCoords.y );

                    ele.style.transform = 'translate3d(' + resultX + 'px,' + resultY + 'px,0)';

                }

            }

            function getSlotIdByCoords ( coords ) {

                // Get the current slot being hovered over
                for ( var id in _imageSlots ) {
                    var slot = _imageSlots[id];
                    if ( slot.x <= coords.x && coords.x <= slot.x + slot.width && slot.y <= coords.y && coords.y <= slot.y + slot.height )
                        return id;
                }
            }
            function getIndexOfImageId ( id ) {
                var i = 0,
                        len = _listedImageIds.length;

                for ( ; i < len; i++ )
                    if ( _listedImageIds[i] == id )
                        return i;
            }
        })();

        // const threeByThreeTopster = $('#3x3');
        // const fourByFourTopster = $('#4x4');
        // const fiveByFiveTopster = $('#5x5');



        const searchBar = $("#search-bar");
        const searchButton = $("#search-button");
        const searchResults = document.querySelector("#results");
        const albumArtDiv= document.querySelector("#album-art");


        //Following guide at https://www.youtube.com/watch?v=1vR3m0HupGI&ab_channel=MakerAtPlayCoding
        var redirect_uri = "http://localhost:8080/create-topster";
        const AUTHORIZE = "https://accounts.spotify.com/authorize";
        const TOKEN = "https://accounts.spotify.com/api/token";

        var access_token = null;
        var refresh_token = null;

        function changeSelection(){
            console.log($("#topster-type").val());
            switch ($("#topster-type").val()){
                case "3x3":
                    $("#3x3").css("display", "block");
                    $("#4x4").css("display", "none");
                    $("#5x5").css("display", "none");
                    break;
                case "4x4":
                    $("#3x3").css("display", "none");
                    $("#4x4").css("display", "block");
                    $("#5x5").css("display", "none");
                    break;
                case "5x5":
                    $("#3x3").css("display", "none");
                    $("#4x4").css("display", "none");
                    $("#5x5").css("display", "block");
                    break;
                default:
                    console.log("This should never happen")
            }
        }

        function onPageLoad(){
            if(window.location.search.length > 0){
                handleRedirect();
            }
        }

        function handleRedirect(){
            let code = getCode();
            fetchAccessToken( code );
            window.history.pushState("", "", redirect_uri); // remove param from url
        }

        function fetchAccessToken( code ){
            let body = "grant_type=client_credentials";
            body += "&code=" + code;
            body += "&redirect_uri=" + encodeURI(redirect_uri);
            body += "&client_id=" + SPOTIFY_CLIENT_ID;
            body += "&client_secret=" + SPOTIFY_CLIENT_SECRET;
            callAuthorizationApi(body);
        }
        function getCode(){
            let code = null;
            const queryString = window.location.search;
            if ( queryString.length > 0 ){
                const urlParams = new URLSearchParams(queryString);
                code = urlParams.get('code')
            }
            return code;
        }

        function callAuthorizationApi(body){
            let xhr = new XMLHttpRequest();
            xhr.open("POST", TOKEN, true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.setRequestHeader('Authorization', 'Basic ' + btoa(SPOTIFY_CLIENT_ID + ":" + SPOTIFY_CLIENT_SECRET));
            xhr.send(body);
            xhr.onload = handleAuthorizationResponse;
        }

        function handleAuthorizationResponse(){
            if ( this.status == 200 ){
                var data = JSON.parse(this.responseText);
                console.log(data);
                var data = JSON.parse(this.responseText);

                access_token = data.access_token;
                localStorage.setItem("access_token", access_token);

                if ( data.refresh_token  != undefined ){
                    refresh_token = data.refresh_token;
                    localStorage.setItem("refresh_token", refresh_token);
                }
                onPageLoad();
            }
            else {
                console.log(this.responseText);
                alert(this.responseText);
            }
        }

        function requestAuthorization(){

            localStorage.setItem("client_id", SPOTIFY_CLIENT_ID);
            localStorage.setItem("client_secret", SPOTIFY_CLIENT_SECRET);

            let url = AUTHORIZE;
            url += "?client_id=" + SPOTIFY_CLIENT_ID;
            url += "&response_type=code";
            url += "&redirect_uri=" + encodeURI(redirect_uri);
            url += "&shot_dialogue=true";
            url += "&scope=user-read-private user-read-email user-modify-playback-state user-read-playback-position user-library-read streaming user-read-playback-state user-read-recently-played playlist-read-private";
            window.location.href = url;
        }

        function refreshAccessToken(){
            refresh_token = localStorage.getItem("refresh_token");
            let body = "grant_type=refresh_token";
            body += "&refresh_token=" + refresh_token;
            body += "&client_id=" + SPOTIFY_CLIENT_ID;
            callAuthorizationApi(body);
        }

        function handleApiResponse(){
            if ( this.status == 200){
                console.log(this.responseText);
                setTimeout(currentlyPlaying, 2000);
            }
            else if ( this.status == 204 ){
                setTimeout(currentlyPlaying, 2000);
            }
            else if ( this.status == 401 ){
                refreshAccessToken()
            }
            else {
                console.log(this.responseText);
                alert(this.responseText);
            }
        }

        searchButton.click(function (){
            console.log(searchBar.val());
            let options = {
                headers: {
                    Accept: "application/json",
                    Authorization: "Bearer "+access_token,
                    "Content-Type": "application/json"
                },
                method: "Get"
            };

            fetch("https://api.spotify.com/v1/search?q=" + searchBar.val() +"&type=album,artist", options)
                    .then(res => res.json())
                    .then(data => {
                        // console.log(data);
                        searchResults.innerHTML = "";
                        data.albums.items.forEach(function (album){
                            let albumString = "Artist: " + album.artists[0].name;
                            albumString += "\nAlbum: "+ album.name;
                            albumString += "\nRelease Date: "+ album.release_date;
                            let albumArtUrl = album.images[0].url;
                            // console.log(albumArtUrl);
                            // console.log(albumString);
                            searchResults.innerHTML +=
                                    `<div class="search-result col-4">
                                        <img title="${albumString}" src="${albumArtUrl}" alt="${album.name} cover art" width="120" height="120" draggable="true">
<!--                                        <div class="album-details">-->
<!--                                            ${albumString}-->
<!--                                        </div>-->
                                    </div>`;

//                            This is code to render the albums as flip cards. However, the css is funky and they move to the side when you mouse over them.
//                             `
//                                     <div class="search-result col-4 flip-box">
//                                         <div class="flip-box-inner">
//                                             <div class="flip-box-front">
// <!--                                              Whenever we adjust the size of the image, we'll need to adjust the size of the css flip-box elements accordingly-->
//                                                 <img src="${albumArtUrl}" alt="${album.name} cover art" class="album-art" width="120" height="120" draggable="true">
//                                             </div>
//                                             <div class="album-details flip-box-back">
//                                                 <p>${albumString}</p>
//                                             </div>
//                                         </div>
//                                     </div>`;

                            // searchResults.innerText += albumString;
                        });
                    })
                    .catch(error => console.error(error));
        });

        changeSelection(); //This should cause non-selected topster types to be set to display-none
    </script>
</body>
</html>